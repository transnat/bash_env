---
- name: 'Harden sshd.'
  become: true
  tags:
      - 'ssh'
  block:
      - name: 'Harden /etc/ssh/sshd_config'
        ansible.builtin.lineinfile:
            create: true
            path: '/etc/ssh/sshd_config'
            regexp: '{{ item.regex }}'
            line: '{{ item.line }}'
            state: 'present'
            validate: '/usr/sbin/sshd -t -f %s'
            mode: '0644'
        loop:
            - { regexp: '(?i)^\s*^AllowAgentForwarding', line: 'AllowAgentForwarding no' }
            - { regexp: '(?i)^\s*^AllowGroups', line: 'AllowGroups sshusers' }
            - { regexp: '(?i)^\s*^ClientAliveCountMax', line: 'ClientAliveCountMax 0'}
            - { regexp: '(?i)^\s*^ClientAliveInterval', line: 'ClientAliveInterval 300'}
            - { regexp: '(?i)^\s*^HostbasedAuthentication', line: 'HostbasedAuthentication no' }
            - { regexp: '(?i)^\s*^ListenAddress', line: 'ListenAddress 0.0.0.0'}
            - { regexp: '(?i)^\s*^LoginGraceTime', line: 'LoginGraceTime 30'}
            - { regexp: '(?i)^\s*^MaxAuthTries', line: 'MaxAuthTries 2'}
            - { regexp: '(?i)^\s*^MaxSessions', line: 'MaxSessions 2'}
            - { regexp: '(?i)^\s*^MaxStartups', line: 'MaxStartups 2'}
            - { regexp: '(?i)^\s*^PasswordAuthentication', line: 'PasswordAuthentication no'}
            - { regexp: '(?i)^\s*^PermitRootLogin', line: 'PermitRootLogin no'}
            - { regexp: '(?i)^\s*^Port', line: 'Port {{ ssh_port }}'}
            - { regexp: '(?i)^\s*^Subsystem', line: 'Subsystem sftp  internal-sftp -f AUTHPRIV -l INFO'}
            - { regexp: '(?i)^\s*^X11Forwarding', line: 'X11Forwarding no'}

      - name: 'Remove short Diffie-Hellman.'
        ansible.builtin.shell: |
            set -o pipefail
            awk '$5 >= 3071' /etc/ssh/moduli | tee /etc/ssh/moduli.tmp
            mv /etc/ssh/moduli.tmp /etc/ssh/moduli
        changed_when: false
        notify: 'Restart SSHD.'
...
