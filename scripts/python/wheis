#!/usr/bin/env python3
# -*- coding: utf-8 -*-

# Author:       Casey Sparks
# Date:         January 25, 2022
# Description:
'''
whois for IP locations.
'''

import locale
import logging
import os
import sys
import requests
from typing import NoReturn

# Enable logging, set locale, set args.
log = logging.getLogger()

locale.setlocale(locale.LC_ALL, 'en_US.UTF-8')
log.addHandler(logging.StreamHandler())
log.setLevel(logging.INFO)


def get_location_table(ip_address: str, api_key: str):
    '''
    Gets location data from IPStack.com and returns it as a list of lists.
        :param ip_address:  The IP address to get location info for.
        :param api_key:     The IPStack API key for the request.
    '''
    ip_info = requests.get(
        f'http://api.ipstack.com/{ip}',
        params={'access_key': api_key}
    ).json()

    location_table = [
        ['IP:', ip_info["ip"]],
        ['City:', ip_info["city"]],
        ['Region:', ip_info["region_name"]],
        ['ZIP:', ip_info["zip"]],
        ['Country:', ip_info["country_name"]],
        ['Coordinates:', f'{ip_info["latitude"]}, {ip_info["longitude"]}']
    ]

    return location_table


def fprint(location_table: list) -> NoReturn:
    '''
    Formats and prints a list of lists as a table.
        :param table: The location to format/print.
    '''
    for row in location_table:
        print('{: <16} {: >0}'.format(*row))


if __name__ == '__main__':
    api_key = os.getenv('IPSTACK_API_KEY')

    if api_key is None:
        log.critical('No API key.')
    else:
        for ip in sys.argv[1:]:
            fprint(get_location_table(ip))
